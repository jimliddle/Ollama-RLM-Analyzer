<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Closed-Loop RLM Explorer + Prompt Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .glass {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-transition {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.98); }
        }
        .analyzing { animation: pulse-subtle 2s infinite ease-in-out; }

        .typing::after {
            content: "▊";
            animation: blink 1s steps(2) infinite;
            margin-left: 2px;
            color: #3b82f6;
        }
        @keyframes blink { 0% { opacity: 0; } }

        .phase-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 800;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebarContainer" class="sidebar-transition w-80 glass flex flex-col border-r border-slate-800 h-full z-50 overflow-hidden shrink-0">
        <div class="p-6 flex items-center justify-between min-w-[20rem]">
            <div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">Ollama RLM Analyzer</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">A local programmatic RLM implementation</p>
            </div>
            <button onclick="toggleSidebar()" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all" title="Hide Sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </button>
        </div>

        <!-- New Analysis Button -->
        <div class="px-4 mb-4 min-w-[20rem]">
            <button onclick="resetWorkspace()" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold py-2.5 px-4 rounded-xl transition-all flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                New Analysis
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar px-4 space-y-2 pb-20 min-w-[20rem]" id="historyList"></div>

        <div class="p-4 border-t border-slate-800 flex flex-col gap-2 min-w-[20rem]">
            <button onclick="openPromptLab()" class="w-full text-xs text-slate-300 hover:bg-indigo-900/40 hover:text-indigo-200 p-2 rounded transition-colors flex items-center gap-2 border border-transparent hover:border-indigo-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                Prompt Lab (System Prompts)
            </button>
            <button onclick="openSettings()" class="w-full text-xs text-slate-300 hover:bg-slate-800 p-2 rounded transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                Ollama Settings
            </button>
            <button onclick="clearHistory()" class="w-full text-xs text-slate-500 hover:text-red-400 p-2 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                Clear History
            </button>
        </div>
    </aside>

    <!-- Prompt Lab Modal -->
    <div id="promptLabModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[110] flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-slate-900 w-full max-w-4xl p-8 rounded-2xl border border-slate-700 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold text-indigo-400">Prompt Lab</h3>
                    <p class="text-xs text-slate-500">Edit system behavior. Variables in {BRACKETS} are required.</p>
                </div>
                <button onclick="closePromptLab()" class="text-slate-500 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-6 pr-4">
                <div class="space-y-2">
                    <label class="block text-[10px] uppercase font-bold text-slate-400">1. Objective Refiner Prompt <span class="text-indigo-400 lowercase italic">({OBJECTIVE})</span></label>
                    <textarea id="lab_refiner" class="w-full h-24 bg-slate-800 border border-slate-700 rounded-lg p-3 text-xs font-mono focus:border-indigo-500 focus:outline-none"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] uppercase font-bold text-slate-400">2. Extraction Prompt <span class="text-indigo-400 lowercase italic">({OBJECTIVE}, {CHUNK})</span></label>
                    <textarea id="lab_extraction" class="w-full h-32 bg-slate-800 border border-slate-700 rounded-lg p-3 text-xs font-mono focus:border-indigo-500 focus:outline-none"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] uppercase font-bold text-slate-400">3. Consolidation Prompt <span class="text-indigo-400 lowercase italic">({OBJECTIVE}, {FACTS})</span></label>
                    <textarea id="lab_consolidation" class="w-full h-32 bg-slate-800 border border-slate-700 rounded-lg p-3 text-xs font-mono focus:border-indigo-500 focus:outline-none"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] uppercase font-bold text-slate-400">4. Audit & Verification Prompt <span class="text-indigo-400 lowercase italic">({DRAFT}, {FACTS})</span></label>
                    <textarea id="lab_audit" class="w-full h-32 bg-slate-800 border border-slate-700 rounded-lg p-3 text-xs font-mono focus:border-indigo-500 focus:outline-none"></textarea>
                </div>
            </div>

            <div class="pt-6 flex justify-between items-center border-t border-slate-800 mt-4">
                <button onclick="resetPromptsToDefault()" class="text-xs text-slate-500 hover:text-red-400 flex items-center gap-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    Reset all to baseline defaults
                </button>
                <div class="flex gap-2">
                    <button onclick="closePromptLab()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-bold px-6 py-2 rounded-xl transition-all">Cancel</button>
                    <button onclick="saveLabPrompts()" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold px-8 py-2 rounded-xl transition-all">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[100] flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-slate-900 w-full max-w-md p-6 rounded-2xl border border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">Ollama Configuration</h3>
                <button onclick="closeSettings()" class="text-slate-500 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-500 mb-2">Endpoint URL</label>
                    <div class="flex gap-2">
                        <input id="ollamaUrl" type="text" value="http://localhost:11434" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500">
                        <button onclick="fetchModels()" class="bg-slate-700 hover:bg-slate-600 px-3 rounded-lg transition-colors"><svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg></button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-500 mb-2">Active Model</label>
                    <select id="modelSelect" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 appearance-none"></select>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-500 mb-2">Chunk Size (Chars)</label>
                    <input id="chunkSize" type="number" value="6000" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:outline-none">
                </div>
                <div class="pt-4"><button onclick="closeSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all">Apply Configuration</button></div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="mainContent" class="flex-1 flex flex-col h-full bg-slate-950 overflow-hidden">
        
        <header class="p-4 border-b border-slate-800 flex items-center gap-4 bg-slate-950/50 backdrop-blur-md sticky top-0 z-30">
            <button id="sidebarOpenBtn" onclick="toggleSidebar()" class="p-2 glass rounded-lg text-slate-400 hover:text-white transition-all hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M3 6h18"/><path d="M3 18h18"/></svg>
            </button>
            <span id="headerTitle" class="font-bold text-slate-300">RLM Analyzer</span>
            <span id="headerModelBadge" class="text-[9px] px-2 py-1 rounded bg-blue-500/15 text-blue-400 border border-blue-500/30 font-mono hidden"></span>
            <div class="flex-1"></div>
            <div id="programmaticProgress" class="hidden flex items-center gap-3">
                <div class="text-[10px] font-mono text-blue-400 uppercase tracking-widest" id="stepLabel">Ready</div>
                <div class="w-32 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
                </div>
            </div>
        </header>

        <div id="outputArea" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
            <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto space-y-6">
                <div class="w-20 h-20 bg-blue-500/10 rounded-3xl flex items-center justify-center border border-blue-500/20 shadow-inner">
                    <svg class="text-blue-400" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10"/><path d="M18.4 4.6a10 10 0 1 1-12.8 0"/></svg>
                </div>
                <div>
                    <h2 class="text-3xl font-bold mb-4 tracking-tight text-white">Sequential Audit Engine</h2>
                    <p class="text-slate-400 leading-relaxed">A high-fidelity Ollama RLM implementation. Providing document coverage with a final verification pass to mitigate data loss from technical chunks.</p>
                </div>
            </div>
            <div id="activeResponse" class="hidden max-w-5xl mx-auto space-y-8 pb-12"></div>
        </div>

        <!-- Input Area -->
        <div class="p-4 md:p-6 border-t border-slate-800 glass relative">
            <div class="max-w-5xl mx-auto">
                <div id="refinementCard" class="hidden mb-4 p-4 bg-indigo-500/10 border border-indigo-500/30 rounded-2xl animate-in slide-in-from-bottom-2">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="phase-badge bg-indigo-500 text-white">Objective Refiner</span>
                        <div class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Cognitive Suggestion</div>
                    </div>
                    <div id="suggestionText" class="text-sm text-slate-300 mb-4 italic leading-relaxed"></div>
                    <div class="flex gap-2">
                        <button id="applyRefinementBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold px-4 py-2 rounded-lg">Apply Suggestion</button>
                        <button id="skipRefinementBtn" class="bg-slate-800 hover:bg-slate-700 text-slate-400 text-xs font-bold px-4 py-2 rounded-lg">Skip & Run Original</button>
                    </div>
                </div>

                <div id="filePreview" class="hidden mb-4 flex items-center justify-between p-3 bg-blue-500/10 border border-blue-500/30 rounded-xl">
                    <div class="flex items-center gap-3">
                        <svg class="text-blue-400" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        <div>
                            <span id="fileName" class="text-sm font-medium text-blue-100 block truncate max-w-[200px]">document.pdf</span>
                            <span id="fileStatus" class="text-[10px] text-blue-400 uppercase font-bold">Ready</span>
                        </div>
                    </div>
                    <button onclick="removeFile()" class="p-2 hover:bg-blue-500/20 rounded-lg text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>

                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-1 relative group">
                        <textarea id="sourceInput" class="w-full h-24 bg-slate-900/50 border border-slate-800 rounded-xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/30 transition-all placeholder-slate-600 custom-scrollbar" placeholder="Paste source text or drag file here..."></textarea>
                        <div class="absolute bottom-3 right-3">
                            <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.txt" onchange="handleFileSelect(event)">
                            <button onclick="document.getElementById('fileInput').click()" class="p-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg border border-slate-700 transition-colors shadow-sm" title="Attach Document"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.51a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg></button>
                        </div>
                    </div>
                    <div class="flex-1">
                        <textarea id="objectiveInput" class="w-full h-24 bg-slate-900/50 border border-slate-800 rounded-xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition-all placeholder-slate-600 custom-scrollbar" placeholder="Define objective (e.g. Audit for specific legal risks)"></textarea>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div id="statusIndicator" class="hidden text-xs text-slate-400 flex items-center gap-3">
                        <div class="flex space-x-1"><div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div><div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.3s]"></div></div>
                        <span id="statusText">Active...</span>
                    </div>
                    <div class="flex-1"></div>
                    <button id="runBtn" onclick="initiateRLM()" class="bg-blue-600 hover:bg-blue-500 disabled:bg-slate-800 disabled:text-slate-600 text-white px-8 py-3 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-blue-950/40 flex items-center gap-2">
                        <span>Execute Pipeline</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m13 17 5-5-5-5"/><path d="M6 17l5-5-5-5"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- HARDCODED BASELINE DEFAULTS ---
        const DEFAULTS = {
            refiner: `Analyze this objective for a document audit. 
Check if it is too narrow (causing lazy output) or too broad (causing vague output).
=== OBJECTIVE ===
{OBJECTIVE}

=== PROTOCOL ===
If the objective is optimal, say "OBJECTIVE_OK". 
Otherwise, provide a single improved version starting with "Suggestion:". 
Include a brief critique.`,
            extraction: `You are a High-Fidelity Information Extractor.
Process this segment of the document.
=== OBJECTIVE ===
{OBJECTIVE}

=== SEGMENT ===
{CHUNK}

=== PROTOCOL ===
EXTRACT technical data, names, and complete lists verbatim. 
- IMPORTANT: If a list exists (e.g. Member States), extract it IN FULL exactly as it appears. 
- Do not paraphrase requirements. Quote verbatim.
- Treat blank fields, dotted lines, and form inputs as mandatory requirements (e.g. "The bank shall be:........" means bank details are required).
- Label: [VERIFIED] / [INFERRED].
Limit: 400 words.`,
            consolidation: `You are a Document Consolidator. 
Merge individual segment reports into a draft response. 
DO NOT FILTER. NO LOSS OF DETAIL.

=== OBJECTIVE ===
{OBJECTIVE}

=== SEGMENT DATA ===
{FACTS}

=== PROTOCOL ===
Synthesize into a final draft. Preserve technical names and verbatim lists.
End with "Confidence: [HIGH/MEDIUM/LOW]" and a one-sentence justification.`,
            audit: `You are a Document Auditor. 
Compare a DRAFT REPORT against the original RAW DATA.

=== DRAFT REPORT ===
{DRAFT}

=== RAW DATA ===
{FACTS}

=== PROTOCOL ===
Identify any specific technical data, verbatim list items, or requirements present in the RAW DATA but missing or truncated in the DRAFT.
If missing, provide it under "### AUDIT CORRECTIONS".
If accurate, say "VERIFICATION COMPLETE."`
        };

        // --- CURRENT ACTIVE PROMPTS ---
        let ACTIVE_PROMPTS = { ...DEFAULTS };

        let currentExtractedText = "";
        let isSidebarOpen = true;

        // UI HELPERS
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebarContainer');
            const openBtn = document.getElementById('sidebarOpenBtn');
            isSidebarOpen = !isSidebarOpen;
            if (isSidebarOpen) {
                sidebar.style.width = "20rem";
                sidebar.classList.remove('-translate-x-full');
                openBtn.classList.add('hidden');
            } else {
                sidebar.style.width = "0";
                sidebar.classList.add('-translate-x-full');
                openBtn.classList.remove('hidden');
            }
        }

        function resetWorkspace() {
            document.getElementById('fileInput').value = "";
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('sourceInput').value = "";
            document.getElementById('objectiveInput').value = "";
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('activeResponse').classList.add('hidden');
            document.getElementById('activeResponse').innerHTML = '';
            document.getElementById('refinementCard').classList.add('hidden');
            currentExtractedText = "";
            document.getElementById('outputArea').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); setTimeout(() => document.getElementById('settingsModal').classList.add('opacity-100'), 10); fetchModels(); }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('opacity-100'); setTimeout(() => document.getElementById('settingsModal').classList.add('hidden'), 300); }

        function openPromptLab() {
            document.getElementById('lab_refiner').value = ACTIVE_PROMPTS.refiner;
            document.getElementById('lab_extraction').value = ACTIVE_PROMPTS.extraction;
            document.getElementById('lab_consolidation').value = ACTIVE_PROMPTS.consolidation;
            document.getElementById('lab_audit').value = ACTIVE_PROMPTS.audit;
            document.getElementById('promptLabModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('promptLabModal').classList.add('opacity-100'), 10);
        }

        function closePromptLab() {
            document.getElementById('promptLabModal').classList.remove('opacity-100');
            setTimeout(() => document.getElementById('promptLabModal').classList.add('hidden'), 300);
        }

        async function saveLabPrompts() {
            ACTIVE_PROMPTS.refiner = document.getElementById('lab_refiner').value;
            ACTIVE_PROMPTS.extraction = document.getElementById('lab_extraction').value;
            ACTIVE_PROMPTS.consolidation = document.getElementById('lab_consolidation').value;
            ACTIVE_PROMPTS.audit = document.getElementById('lab_audit').value;
            
            const tx = db.transaction(["settings"], "readwrite");
            tx.objectStore("settings").put({ id: "system_prompts", data: ACTIVE_PROMPTS });
            tx.oncomplete = () => {
                closePromptLab();
                showToast("System prompts saved successfully.");
            };
        }

        function resetPromptsToDefault() {
            if(!confirm("Reset all prompts to baseline defaults?")) return;
            ACTIVE_PROMPTS = { ...DEFAULTS };
            document.getElementById('lab_refiner').value = ACTIVE_PROMPTS.refiner;
            document.getElementById('lab_extraction').value = ACTIVE_PROMPTS.extraction;
            document.getElementById('lab_consolidation').value = ACTIVE_PROMPTS.consolidation;
            document.getElementById('lab_audit').value = ACTIVE_PROMPTS.audit;
            saveLabPrompts();
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = "fixed bottom-8 right-8 bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-2xl z-[200] animate-in fade-in slide-in-from-bottom-4";
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => { t.classList.add('fade-out'); setTimeout(() => t.remove(), 500); }, 3000);
        }

        // FILE HANDLERS
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('filePreview').classList.remove('hidden');
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileStatus').innerText = "Parsing...";
            try {
                if (file.type === "application/pdf" || file.name.endsWith('.pdf')) currentExtractedText = await parsePDF(file);
                else if (file.name.endsWith('.docx')) currentExtractedText = await parseDocx(file);
                else currentExtractedText = await file.text();
                const wordCount = currentExtractedText.trim().split(/\s+/).filter(Boolean).length;
                document.getElementById('fileStatus').innerText = `${wordCount} words`;
            } catch (err) { document.getElementById('fileStatus').innerText = "Error"; }
        }

        function removeFile() { document.getElementById('filePreview').classList.add('hidden'); currentExtractedText = ""; }

        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + "\n";
            }
            return text;
        }

        async function parseDocx(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        async function fetchModels() {
            const url = document.getElementById('ollamaUrl').value.trim();
            const select = document.getElementById('modelSelect');
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('animate-spin');
            try {
                const response = await fetch(`${url}/api/tags`);
                const data = await response.json();
                select.innerHTML = '';
                data.models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.name; opt.innerText = m.name;
                    select.appendChild(opt);
                });
                updateModelBadge();
                select.onchange = updateModelBadge;
            } catch (err) { select.innerHTML = '<option value="">Failed to fetch</option>'; }
            finally { icon.classList.remove('animate-spin'); }
        }

        function updateModelBadge() {
            const model = document.getElementById('modelSelect').value;
            const badge = document.getElementById('headerModelBadge');
            if (model && model !== 'Failed to fetch') {
                badge.innerText = model;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // --- DATABASE ---
        let db;
        const dbRequest = indexedDB.open("RLM_v10_LabDB", 1);
        dbRequest.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("sessions")) db.createObjectStore("sessions", { keyPath: "id", autoIncrement: true });
            if (!db.objectStoreNames.contains("settings")) db.createObjectStore("settings", { keyPath: "id" });
        };
        dbRequest.onsuccess = (e) => { 
            db = e.target.result; 
            loadHistory(); 
            // Load custom prompts
            db.transaction("settings", "readonly").objectStore("settings").get("system_prompts").onsuccess = (ev) => {
                if(ev.target.result) ACTIVE_PROMPTS = ev.target.result.data;
            };
        };

        async function saveSession(source, objective, result, modelName) {
            const transaction = db.transaction(["sessions"], "readwrite");
            transaction.objectStore("sessions").add({ 
                source: source.substring(0, 10000), objective, result, modelName, timestamp: new Date().toISOString() 
            });
            loadHistory();
        }

        function loadHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            const store = db.transaction(["sessions"], "readonly").objectStore("sessions");
            store.openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const data = cursor.value;
                    const div = document.createElement('div');
                    div.className = 'p-3 glass rounded-xl cursor-pointer hover:border-blue-500/50 transition-all border border-transparent group mb-2 relative overflow-hidden';
                    div.onclick = () => displaySession(data);
                    div.innerHTML = `
                        <div class="text-[9px] text-slate-500 font-bold mb-0.5 uppercase tracking-tighter">${new Date(data.timestamp).toLocaleString()}</div>
                        <div class="text-[9px] text-blue-400 font-mono mb-1 truncate">MODEL: ${data.modelName || 'Local'}</div>
                        <div class="text-xs font-semibold text-slate-200 truncate pr-12">${data.objective}</div>
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-900/80 p-1 rounded-lg">
                            <button onclick="event.stopPropagation(); renameSession(${data.id}, '${data.objective.replace(/'/g, "\\'")}')" class="p-1 hover:text-blue-400 text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button onclick="event.stopPropagation(); deleteSession(${data.id})" class="p-1 hover:text-red-400 text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
                        </div>
                    `;
                    list.appendChild(div); cursor.continue();
                }
            };
        }

        async function deleteSession(id) { if(confirm("Delete analysis?")) { db.transaction(["sessions"], "readwrite").objectStore("sessions").delete(id).oncomplete = loadHistory; } }
        async function renameSession(id, old) { 
            const n = prompt("Rename analysis title:", old); 
            if(n && n !== old) { 
                const s = db.transaction(["sessions"], "readwrite").objectStore("sessions");
                s.get(id).onsuccess = (e) => { e.target.result.objective = n; s.put(e.target.result).oncomplete = loadHistory; };
            } 
        }

        function formatDisplay(text) {
            return text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b class="text-white">$1</b>').replace(/### (.*?)(<br>|$)/g, '<h4 class="text-blue-400 font-bold mt-4 mb-1 uppercase tracking-tight">$1</h4>').replace(/## (.*?)(<br>|$)/g, '<h3 class="text-indigo-400 font-bold mt-6 mb-2 border-b border-slate-800 pb-1">$1</h3>');
        }

        function exportReport(obj, res, mod) {
            const blob = new Blob([`# RLM Report: ${obj}\nModel: ${mod}\n\n${res.replace(/<br>/g, '\n')}`], { type: 'text/markdown' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `RLM_Report.md`; a.click();
        }

        function exportPDF(obj, res, mod) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const maxWidth = pageWidth - (margin * 2);
            let yPos = margin;
            
            // Colors
            const blue = [59, 130, 246];
            const emerald = [16, 185, 129];
            const amber = [245, 158, 11];
            const slate = [100, 116, 139];
            const dark = [30, 41, 59];
            const lightGray = [245, 245, 245];
            
            // Helper: Check page break
            const checkPage = (needed = 10) => {
                if (yPos > pageHeight - margin - needed) {
                    doc.addPage();
                    yPos = margin;
                }
            };
            
            // Helper: Draw badge
            const drawBadge = (text, color, x, y) => {
                doc.setFillColor(...color);
                const textWidth = doc.getTextWidth(text) + 6;
                doc.roundedRect(x, y - 4, textWidth, 6, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text(text, x + 3, y);
                return textWidth;
            };
            
            // Title Header with badge
            drawBadge('RLM ANALYSIS REPORT', dark, margin, yPos);
            yPos += 10;
            
            // Model info
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...slate);
            doc.text(`Model: ${mod}`, margin, yPos);
            yPos += 8;
            
            // Objective section
            doc.setFillColor(240, 249, 255);
            doc.roundedRect(margin, yPos - 2, maxWidth, 20, 2, 2, 'F');
            doc.setDrawColor(...blue);
            doc.setLineWidth(0.5);
            doc.line(margin, yPos - 2, margin, yPos + 18);
            
            doc.setFontSize(8);
            doc.setTextColor(...slate);
            doc.setFont('helvetica', 'bold');
            doc.text('OBJECTIVE', margin + 4, yPos + 3);
            
            doc.setFontSize(10);
            doc.setTextColor(0);
            doc.setFont('helvetica', 'normal');
            const objLines = doc.splitTextToSize(obj, maxWidth - 8);
            doc.text(objLines.slice(0, 2), margin + 4, yPos + 9);
            yPos += 26;
            
            // Horizontal divider
            doc.setDrawColor(220);
            doc.setLineWidth(0.2);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            // Process content with styling
            let content = res
                .replace(/<br>/g, '\n')
                .replace(/<[^>]*>/g, '')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"');
            
            const lines = content.split('\n');
            let inAuditTable = false;
            let auditTableRows = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) { yPos += 3; continue; }
                
                // Skip markdown table separator lines
                if (/^\|[-:\s|]+\|$/.test(line)) continue;
                
                // Detect audit table header
                if (/^\|\s*DRAFT REPORT Detail\s*\|/.test(line) || /^\|\s*\(1\)\s*Name and address\s*\|/.test(line)) {
                    inAuditTable = true;
                    auditTableRows = [];
                    continue;
                }
                
                // Handle audit/data table rows
                if (inAuditTable && line.startsWith('|') && line.endsWith('|')) {
                    // Parse table row
                    const cells = line.split('|').filter(c => c.trim()).map(c => c.trim());
                    if (cells.length > 0 && cells[0] !== '---') {
                        checkPage(20);
                        
                        // Draw alternating background
                        if (auditTableRows.length % 2 === 0) {
                            doc.setFillColor(...lightGray);
                            doc.rect(margin, yPos - 3, maxWidth, 18, 'F');
                        }
                        
                        // Draw left border for visual separation
                        doc.setDrawColor(...blue);
                        doc.setLineWidth(0.5);
                        doc.line(margin, yPos - 3, margin, yPos + 15);
                        
                        // First cell (main content) - bold
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0);
                        const mainContent = cells[0] || '';
                        const mainLines = doc.splitTextToSize(mainContent, maxWidth - 10);
                        doc.text(mainLines[0], margin + 3, yPos);
                        
                        // Status/verification cell if exists
                        if (cells.length >= 3 && cells[2]) {
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(8);
                            // Color code based on status
                            if (cells[2].includes('VERIFICATION COMPLETE')) {
                                doc.setTextColor(...emerald);
                            } else if (cells[2].includes('AUDIT CORRECTION NEEDED')) {
                                doc.setTextColor(...amber);
                            } else {
                                doc.setTextColor(...slate);
                            }
                            const statusLines = doc.splitTextToSize(cells[2], maxWidth - 10);
                            doc.text(statusLines[0], margin + 3, yPos + 5);
                            if (statusLines[1]) doc.text(statusLines[1], margin + 3, yPos + 9);
                        }
                        
                        yPos += 18;
                        auditTableRows.push(cells);
                    }
                    continue;
                }
                
                // End of table detection
                if (inAuditTable && !line.startsWith('|')) {
                    inAuditTable = false;
                    yPos += 4;
                }
                
                checkPage(12);
                
                // Section headers - expanded pattern to catch "Risk Category X:" and "Audit of DRAFT REPORT"
                if (/^(I{1,3}V?|VI{0,3}|IX|X)\.\s/.test(line) || 
                    /^(Draft Response|Confidence|Overall Assessment|AUDIT CORRECTIONS|VERIFICATION COMPLETE|Word Count|Risk Category \d+|Audit of DRAFT|Overall Risk Assessment|Table Data):?/i.test(line)) {
                    yPos += 4;
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...blue);
                    line = line.replace(/^\*\*|\*\*$/g, '');
                    const headerLines = doc.splitTextToSize(line, maxWidth);
                    doc.text(headerLines, margin, yPos);
                    yPos += (headerLines.length * 5) + 3;
                    continue;
                }
                
                // Category headers (numbered like "1.", "2.", etc. or "Category X:")
                if (/^(\d+\.|Category \d+:)/.test(line)) {
                    yPos += 3;
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(0);
                    line = line.replace(/^\*\*|\*\*$/g, '');
                    const catLines = doc.splitTextToSize(line, maxWidth);
                    doc.text(catLines, margin, yPos);
                    yPos += (catLines.length * 5) + 2;
                    continue;
                }
                
                // Chunk markers
                if (/^(CHUNK \d+|## FACT SEGMENT)/i.test(line)) {
                    yPos += 4;
                    drawBadge(line.replace(/^## /, '').toUpperCase(), blue, margin, yPos);
                    yPos += 8;
                    continue;
                }
                
                // Verification/Final badges
                if (/^(VERIFICATION PASS|FINAL VERIFIED RESULT|Verification Pass)/i.test(line)) {
                    yPos += 4;
                    drawBadge(line.toUpperCase(), amber, margin, yPos);
                    yPos += 8;
                    continue;
                }
                
                // Bullet points
                if (/^[\*\-•]\s/.test(line)) {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0);
                    line = line.replace(/^[\*\-•]\s*/, '');
                    // Check for bold item name (like "* **Contract Form:**")
                    const boldMatch = line.match(/^\*\*([^*]+)\*\*:?\s*/);
                    if (boldMatch) {
                        doc.setFont('helvetica', 'bold');
                        doc.text('•  ' + boldMatch[1] + ':', margin + 2, yPos);
                        const boldWidth = doc.getTextWidth('•  ' + boldMatch[1] + ': ');
                        doc.setFont('helvetica', 'normal');
                        const remainder = line.replace(/^\*\*[^*]+\*\*:?\s*/, '');
                        const remLines = doc.splitTextToSize(remainder, maxWidth - boldWidth - 4);
                        if (remLines[0]) doc.text(remLines[0], margin + 2 + boldWidth, yPos);
                        yPos += 5;
                        for (let j = 1; j < remLines.length; j++) {
                            checkPage();
                            doc.text(remLines[j], margin + 6, yPos);
                            yPos += 5;
                        }
                    } else {
                        line = line.replace(/\*\*/g, '');
                        const bulletLines = doc.splitTextToSize('•  ' + line, maxWidth - 4);
                        doc.text(bulletLines[0], margin + 2, yPos);
                        yPos += 5;
                        for (let j = 1; j < bulletLines.length; j++) {
                            checkPage();
                            doc.text(bulletLines[j], margin + 6, yPos);
                            yPos += 5;
                        }
                    }
                    continue;
                }
                
                // Sub-bullets (indented)
                if (/^\s+[\*\-•]/.test(lines[i])) {
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(60);
                    line = line.replace(/^[\*\-•]\s*/, '').replace(/\*\*/g, '');
                    const subLines = doc.splitTextToSize('◦  ' + line, maxWidth - 10);
                    doc.text(subLines[0], margin + 8, yPos);
                    yPos += 4.5;
                    for (let j = 1; j < subLines.length; j++) {
                        checkPage();
                        doc.text(subLines[j], margin + 12, yPos);
                        yPos += 4.5;
                    }
                    continue;
                }
                
                // Regular paragraph
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0);
                line = line.replace(/\*\*/g, '').replace(/^#+\s*/, '');
                const paraLines = doc.splitTextToSize(line, maxWidth);
                for (const pLine of paraLines) {
                    checkPage();
                    doc.text(pLine, margin, yPos);
                    yPos += 5;
                }
                yPos += 1;
            }
            
            // Footer on each page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(...slate);
                doc.text(`Generated by RLM Analyzer  •  Page ${i} of ${pageCount}`, margin, pageHeight - 10);
                // Add subtle line above footer
                doc.setDrawColor(220);
                doc.setLineWidth(0.1);
                doc.line(margin, pageHeight - 14, pageWidth - margin, pageHeight - 14);
            }
            
            doc.save('RLM_Report.pdf');
        }

        function displaySession(session) {
            document.getElementById('welcomeScreen').classList.add('hidden');
            const c = document.getElementById('activeResponse');
            c.classList.remove('hidden');
            c.innerHTML = `
                <div class="mb-12 p-6 glass rounded-2xl border-l-4 border-emerald-500 shadow-xl flex justify-between items-start">
                    <div>
                        <div class="text-[10px] uppercase font-bold text-slate-500 mb-2">Analysis Report</div>
                        <div class="text-lg font-medium text-slate-100">${session.objective}</div>
                        <div class="text-[10px] font-mono text-emerald-400 mt-2 italic tracking-widest uppercase">Executed via ${session.modelName || 'Local LLM'}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick='exportReport("${session.objective}", \`${session.result}\`, "${session.modelName}")' class="bg-slate-800 hover:bg-slate-700 text-xs px-4 py-2 rounded-lg transition-all flex items-center gap-2 border border-slate-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Export MD
                        </button>
                        <button onclick='exportPDF("${session.objective}", \`${session.result}\`, "${session.modelName}")' class="bg-red-800/50 hover:bg-red-700/50 text-xs px-4 py-2 rounded-lg transition-all flex items-center gap-2 border border-red-700/50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Export PDF
                        </button>
                    </div>
                </div>
                <div class="prose prose-invert max-w-none text-slate-300 space-y-4">${formatDisplay(session.result)}</div>
            `;
            document.getElementById('outputArea').scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function callOllama(prompt, onChunk = null) {
            const url = document.getElementById('ollamaUrl').value.trim();
            const model = document.getElementById('modelSelect').value;
            const response = await fetch(`${url}/api/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model, messages: [{ role: "user", content: prompt }], stream: !!onChunk })
            });
            if (!response.ok) throw new Error("Connection failed.");
            if (!onChunk) return (await response.json()).message.content;
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                decoder.decode(value).split('\n').filter(Boolean).forEach(line => {
                    try { const json = JSON.parse(line); if(json.message) { fullText += json.message.content; onChunk(json.message.content, fullText); } } catch(e) {}
                });
            }
            return fullText;
        }

        async function initiateRLM() {
            const source = currentExtractedText || document.getElementById('sourceInput').value.trim();
            const objective = document.getElementById('objectiveInput').value.trim();
            if (!source || !objective) return alert("Missing data.");

            document.getElementById('runBtn').disabled = true;
            document.getElementById('statusIndicator').classList.remove('hidden');
            document.getElementById('statusText').innerText = "Objective Refiner Active...";

            try {
                const refinerRes = await callOllama(ACTIVE_PROMPTS.refiner.replace('{OBJECTIVE}', objective));
                if (refinerRes.includes("OBJECTIVE_OK")) { startRun(objective, source); } 
                else {
                    const suggestion = refinerRes.split('Suggestion:')[1]?.trim() || refinerRes;
                    document.getElementById('refinementCard').classList.remove('hidden');
                    document.getElementById('suggestionText').innerText = refinerRes;
                    document.getElementById('applyRefinementBtn').onclick = () => { document.getElementById('objectiveInput').value = suggestion; document.getElementById('refinementCard').classList.add('hidden'); startRun(suggestion, source); };
                    document.getElementById('skipRefinementBtn').onclick = () => { document.getElementById('refinementCard').classList.add('hidden'); startRun(objective, source); };
                }
            } catch (e) { startRun(objective, source); }
        }

        async function startRun(objective, source) {
            document.getElementById('statusText').innerText = "Extraction Active...";
            const chunkSize = parseInt(document.getElementById('chunkSize').value) || 6000;
            const activeModel = document.getElementById('modelSelect').value;
            const welcome = document.getElementById('welcomeScreen');
            const activeRes = document.getElementById('activeResponse');
            const outputArea = document.getElementById('outputArea');
            const logLabel = document.getElementById('stepLabel');
            const bar = document.getElementById('progressBar');

            welcome.classList.add('hidden');
            activeRes.classList.remove('hidden');
            document.getElementById('programmaticProgress').classList.remove('hidden');

            activeRes.innerHTML = `
                <div class="mb-12 p-6 glass rounded-2xl border-l-4 border-blue-500 shadow-xl">
                    <div class="text-[10px] uppercase font-bold text-slate-500 mb-1">Active Model: ${activeModel}</div>
                    <div class="text-lg font-medium text-slate-100">${objective}</div>
                    <div class="text-[10px] font-mono text-blue-400 mt-2 italic">Status: Sequential Fact Extraction...</div>
                </div>
                <div id="logTrace" class="space-y-4 mb-8"></div>
                <div id="auditPhase" class="p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl mb-8 hidden"></div>
                <div id="finalReasoning" class="prose prose-invert max-w-none text-slate-300 pt-8 border-t border-slate-800 hidden"></div>
            `;

            try {
                const chunks = [];
                for (let i = 0; i < source.length; i += chunkSize) chunks.push(source.substring(i, i + chunkSize));

                let allFacts = "";
                for (let i = 0; i < chunks.length; i++) {
                    const id = i + 1;
                    logLabel.innerText = `Chunk ${id}/${chunks.length}`;
                    bar.style.width = `${(id / chunks.length) * 80}%`;

                    const block = document.createElement('div');
                    block.className = 'p-4 glass rounded-xl border-l-2 border-slate-700 bg-slate-900/30';
                    block.innerHTML = `<span class="phase-badge bg-blue-600/20 text-blue-400">CHUNK ${id}</span> <span class="typing ml-2 text-sm text-slate-400" id="chunk-txt-${id}">...</span>`;
                    document.getElementById('logTrace').appendChild(block);
                    block.scrollIntoView({ behavior: 'smooth' });

                    const fact = await callOllama(ACTIVE_PROMPTS.extraction.replace('{OBJECTIVE}', objective).replace('{CHUNK}', chunks[i]), (c, f) => {
                        document.getElementById(`chunk-txt-${id}`).innerHTML = formatDisplay(f);
                    });
                    document.getElementById(`chunk-txt-${id}`).classList.remove('typing');
                    if (!fact.toLowerCase().includes("no relevant content")) allFacts += `## FACT SEGMENT ${id}\n${fact}\n\n`;
                }

                logLabel.innerText = "Consolidating...";
                document.getElementById('statusText').innerText = "Consolidation Active...";
                const draft = await callOllama(ACTIVE_PROMPTS.consolidation.replace('{OBJECTIVE}', objective).replace('{FACTS}', allFacts));

                logLabel.innerText = "Audit Pass...";
                document.getElementById('statusText').innerText = "Verification Active...";
                document.getElementById('auditPhase').classList.remove('hidden');
                document.getElementById('auditPhase').innerHTML = `<span class="phase-badge bg-amber-500 text-black">Verification Pass</span> <div class="mt-2 text-sm text-amber-200/70 italic typing" id="auditTxt">Checking for dropped data...</div>`;
                
                const auditRes = await callOllama(ACTIVE_PROMPTS.audit.replace('{DRAFT}', draft).replace('{FACTS}', allFacts), (c, f) => {
                    document.getElementById('auditTxt').innerHTML = formatDisplay(f);
                });
                document.getElementById('auditTxt').classList.remove('typing');

                const finalContent = draft + "\n\n" + auditRes;
                const finalDiv = document.getElementById('finalReasoning');
                finalDiv.classList.remove('hidden');
                finalDiv.innerHTML = `<div class="flex items-center justify-between mb-6"><span class="phase-badge bg-emerald-600 text-white">Final Verified Result</span><div class="flex-1 border-t border-slate-800 mx-4"></div></div><div id="finalTxt"></div>`;
                document.getElementById('finalTxt').innerHTML = formatDisplay(finalContent);

                logLabel.innerText = "Complete"; bar.style.width = "100%";
                await saveSession(source, objective, finalContent, activeModel);

                const expBtn = document.createElement('button');
                expBtn.onclick = () => exportReport(objective, finalContent, activeModel);
                expBtn.className = "bg-emerald-600/20 text-[10px] px-3 py-1 rounded border border-emerald-500/30 transition-all mr-2";
                expBtn.innerText = "Export MD";
                finalDiv.querySelector('.flex').appendChild(expBtn);

                const pdfBtn = document.createElement('button');
                pdfBtn.onclick = () => exportPDF(objective, finalContent, activeModel);
                pdfBtn.className = "bg-red-600/20 text-[10px] px-3 py-1 rounded border border-red-500/30 transition-all";
                pdfBtn.innerText = "Export PDF";
                finalDiv.querySelector('.flex').appendChild(pdfBtn);

            } catch (e) { welcome.classList.remove('hidden'); welcome.innerHTML = `<div class="text-red-400 py-10">Error: ${e.message}</div>`; }
            finally { document.getElementById('runBtn').disabled = false; document.getElementById('statusIndicator').classList.add('hidden'); }
        }

        window.onload = () => { fetchModels(); if(window.innerWidth >= 1024) { isSidebarOpen = true; document.getElementById('sidebarContainer').style.width = "20rem"; } else { isSidebarOpen = false; document.getElementById('sidebarContainer').style.width = "0"; document.getElementById('sidebarOpenBtn').classList.remove('hidden'); } };
    </script>
</body>
</html>
