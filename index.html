<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programmatic RLM Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .glass {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Sidebar Transition */
        .sidebar-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Main Content Transition */
        .main-transition {
            transition: padding-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.98); }
        }
        .analyzing { animation: pulse-subtle 2s infinite ease-in-out; }

        .typing::after {
            content: "â–Š";
            animation: blink 1s steps(2) infinite;
            margin-left: 2px;
            color: #3b82f6;
        }
        @keyframes blink { 0% { opacity: 0; } }

        .phase-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 800;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar: History -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-80 glass flex flex-col border-r border-slate-800 h-full z-50 sidebar-transition translate-x-0">
        <div class="p-6 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">RLM Analyzer</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Programmatic Mode</p>
            </div>
            <button onclick="toggleSidebar()" class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-all" title="Hide Sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar px-4 space-y-2 pb-20" id="historyList"></div>

        <div class="p-4 border-t border-slate-800 flex flex-col gap-2">
            <button onclick="openSettings()" class="w-full text-xs text-slate-300 hover:bg-slate-800 p-2 rounded transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                Ollama Settings
            </button>
            <button onclick="clearHistory()" class="w-full text-xs text-slate-500 hover:text-red-400 p-2 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                Clear Database
            </button>
        </div>
    </aside>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[60] flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="bg-slate-900 w-full max-w-md p-6 rounded-2xl border border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold">Ollama Configuration</h3>
                <button onclick="closeSettings()" class="text-slate-500 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-500 mb-2">Endpoint URL</label>
                    <div class="flex gap-2">
                        <input id="ollamaUrl" type="text" value="http://localhost:11434" 
                            class="flex-1 bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500">
                        <button onclick="fetchModels()" class="bg-slate-700 hover:bg-slate-600 px-3 rounded-lg transition-colors">
                            <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-500 mb-2">Active Model</label>
                    <select id="modelSelect" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 appearance-none"></select>
                </div>
                <div>
                    <label class="block text-[10px] uppercase font-bold text-slate-500 mb-2">Chunk Size (Characters)</label>
                    <input id="chunkSize" type="number" value="6000" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500">
                    <p class="text-[10px] text-slate-500 mt-1">Lower this for models with smaller context windows.</p>
                </div>
                <div class="pt-4">
                    <button onclick="closeSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all">Apply Programmatic Config</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main id="mainContent" class="flex-1 flex flex-col h-full bg-slate-950 overflow-hidden main-transition lg:pl-80">
        
        <!-- Header -->
        <header class="p-4 border-b border-slate-800 flex items-center gap-4 bg-slate-950/50 backdrop-blur-md sticky top-0 z-30">
            <button id="sidebarOpenBtn" onclick="toggleSidebar()" class="p-2 glass rounded-lg text-slate-400 hover:text-white transition-all hidden" title="Show Sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M3 6h18"/><path d="M3 18h18"/></svg>
            </button>
            <span id="headerTitle" class="font-bold text-slate-300">RLM Analyzer</span>
            <div class="flex-1"></div>
            <div id="programmaticProgress" class="hidden flex items-center gap-3">
                <div class="text-[10px] font-mono text-blue-400 uppercase tracking-widest" id="stepLabel">Decomposing...</div>
                <div class="w-32 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
                </div>
            </div>
        </header>

        <!-- Output Display -->
        <div id="outputArea" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
            <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto space-y-6">
                <div class="w-20 h-20 bg-blue-500/10 rounded-3xl flex items-center justify-center border border-blue-500/20 shadow-inner">
                    <svg class="text-blue-400" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10"/><path d="M18.4 4.6a10 10 0 1 1-12.8 0"/></svg>
                </div>
                <div>
                    <h2 class="text-3xl font-bold mb-4 tracking-tight">Programmatic RLM</h2>
                    <p class="text-slate-400 leading-relaxed">This mode physically chunks your document to bypass context limits. It scans the structure, identifies key segments, and recursively extracts facts before synthesis.</p>
                </div>
            </div>

            <div id="activeResponse" class="hidden max-w-5xl mx-auto space-y-8 pb-12"></div>
        </div>

        <!-- Input Area -->
        <div class="p-4 md:p-6 border-t border-slate-800 glass relative">
            <div class="max-w-5xl mx-auto">
                <div id="filePreview" class="hidden mb-4 flex items-center justify-between p-3 bg-blue-500/10 border border-blue-500/30 rounded-xl">
                    <div class="flex items-center gap-3">
                        <svg class="text-blue-400" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        <div>
                            <span id="fileName" class="text-sm font-medium text-blue-100 block truncate max-w-[200px]">document.pdf</span>
                            <span id="fileStatus" class="text-[10px] text-blue-400 uppercase font-bold tracking-tighter">Ready</span>
                        </div>
                    </div>
                    <button onclick="removeFile()" class="p-2 hover:bg-blue-500/20 rounded-lg text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="flex-1 relative group">
                        <textarea id="sourceInput" class="w-full h-24 bg-slate-900/50 border border-slate-800 rounded-xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/30 transition-all custom-scrollbar placeholder-slate-600" placeholder="Paste text or drag file here..."></textarea>
                        <div class="absolute bottom-3 right-3 flex items-center gap-2">
                            <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.txt" onchange="handleFileSelect(event)">
                            <button onclick="document.getElementById('fileInput').click()" class="p-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg border border-slate-700 transition-colors shadow-sm" title="Attach Document">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.51a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1">
                        <textarea id="objectiveInput" class="w-full h-24 bg-slate-900/50 border border-slate-800 rounded-xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition-all custom-scrollbar placeholder-slate-600" placeholder="Objective (e.g. Find specific legal risks)"></textarea>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div id="statusIndicator" class="hidden text-xs text-slate-400 flex items-center gap-3">
                        <div class="flex space-x-1">
                            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></div>
                            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                        </div>
                        <span id="statusText">Active...</span>
                    </div>
                    <div class="flex-1"></div>
                    <button id="runBtn" onclick="runProgrammaticRLM()" class="bg-blue-600 hover:bg-blue-500 disabled:bg-slate-800 disabled:text-slate-600 text-white px-8 py-3 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-blue-950/40 flex items-center gap-2">
                        <span>Run Programmatic RLM</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m13 17 5-5-5-5"/><path d="M6 17l5-5-5-5"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- PROGRAMMATIC PROMPTS ---
        const STRATEGY_PROMPT = `You are a Document Architect in RLM Mode.
Analyze this document "Structure Map" based on 1-indexed Chunk IDs. 
=== OBJECTIVE ===
{OBJECTIVE}

=== STRUCTURE MAP ===
{MAP}

=== PROTOCOL ===
PHASE 1 & 2: Identify which Chunk IDs likely contain the specific, detailed information needed for the objective.
Output ONLY a JSON array of chunk IDs (numbers only).
Example: [1, 3]`;

        const EXTRACTION_PROMPT = `You are an Information Extractor in RLM Mode.
Process this small window of text.
=== OBJECTIVE ===
{OBJECTIVE}

=== TEXT WINDOW ===
{CHUNK}

=== PROTOCOL ===
PHASE 3: Extract ONLY verified, specific facts, technical specs, and concrete details relevant to the objective. 
- Avoid all generic summaries or high-level generalizations.
- If no specific technical facts exist, say "NO RELEVANT CONTENT".
- List facts with confidence: VERIFIED (directly stated) / INFERRED.
- Use bullet points for each distinct fact.
Limit: 250 words.`;

        const SYNTHESIS_PROMPT = `You are a Reasoning Orchestrator in RLM Mode.
=== OBJECTIVE ===
{OBJECTIVE}

=== EXTRACTED FACTS ===
{FACTS}

=== PROTOCOL ===
PHASE 4, 5, 6: Synthesize the extracted facts into a Technical Executive Summary.
IMPORTANT RULES:
1. PRESERVE TECHNICAL DETAIL: Do not summarize details into high-level generic themes. Maintain the specific technical terminology and data from the extractions.
2. STRUCTURE: Use clear, bolded technical categories and bullet points for all facts. Avoid narrative "essay-style" paragraphs.
3. ZERO FLUFF: Do not introduce generic management advice or filler language.
4. SOURCE FIDELITY: Only include information present in the "Extracted Facts" section.
Organize by technical category (e.g., Protocol Specs, Architecture Guidelines, Framework Trade-offs).
End with "Confidence: [HIGH/MEDIUM/LOW]" and a one-sentence justification.`;

        let currentExtractedText = "";
        let isSidebarOpen = true;

        // Optimized Layout Toggling
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const openBtn = document.getElementById('sidebarOpenBtn');
            
            isSidebarOpen = !isSidebarOpen;
            
            if (isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                mainContent.classList.add('lg:pl-80');
                openBtn.classList.add('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                mainContent.classList.remove('lg:pl-80');
                openBtn.classList.remove('hidden');
            }
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('opacity-100'), 10);
            fetchModels();
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('opacity-100');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('filePreview').classList.remove('hidden');
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileStatus').innerText = "Parsing...";
            try {
                if (file.type === "application/pdf" || file.name.endsWith('.pdf')) currentExtractedText = await parsePDF(file);
                else if (file.name.endsWith('.docx')) currentExtractedText = await parseDocx(file);
                else currentExtractedText = await file.text();
                document.getElementById('fileStatus').innerText = `${currentExtractedText.split(/\s+/).length} words`;
            } catch (err) { document.getElementById('fileStatus').innerText = "Error"; }
        }

        function removeFile() {
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('fileInput').value = "";
            currentExtractedText = "";
        }

        async function parsePDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + "\n";
            }
            return text;
        }

        async function parseDocx(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        async function fetchModels() {
            const url = document.getElementById('ollamaUrl').value.trim();
            const select = document.getElementById('modelSelect');
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('animate-spin');
            try {
                const response = await fetch(`${url}/api/tags`);
                const data = await response.json();
                select.innerHTML = '';
                if(data.models) {
                    data.models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.name; opt.innerText = m.name;
                        select.appendChild(opt);
                    });
                }
            } catch (err) { select.innerHTML = '<option value="">Failed to fetch</option>'; }
            finally { icon.classList.remove('animate-spin'); }
        }

        let db;
        const dbRequest = indexedDB.open("RLM_v3_ProgDB", 1);
        dbRequest.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains("sessions")) db.createObjectStore("sessions", { keyPath: "id", autoIncrement: true });
        };
        dbRequest.onsuccess = (e) => { db = e.target.result; loadHistory(); };

        async function saveSession(source, objective, result) {
            const transaction = db.transaction(["sessions"], "readwrite");
            transaction.objectStore("sessions").add({ source: source.substring(0, 10000), objective, result, timestamp: new Date().toISOString() });
            loadHistory();
        }

        function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            const store = db.transaction(["sessions"], "readonly").objectStore("sessions");
            store.openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const div = document.createElement('div');
                    div.className = 'p-3 glass rounded-xl cursor-pointer hover:border-blue-500/50 transition-all border border-transparent group mb-2';
                    div.onclick = () => displaySession(cursor.value);
                    div.innerHTML = `<div class="text-xs font-semibold text-slate-200 truncate">${cursor.value.objective}</div><div class="text-[10px] text-slate-500 mt-1">${new Date(cursor.value.timestamp).toLocaleDateString()}</div>`;
                    historyList.appendChild(div);
                    cursor.continue();
                }
            };
        }

        function clearHistory() { if(confirm("Clear history?")) { db.transaction(["sessions"], "readwrite").objectStore("sessions").clear(); loadHistory(); } }

        function formatDisplay(text) {
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<b class="text-white">$1</b>')
                .replace(/### (.*?)(<br>|$)/g, '<h4 class="text-blue-400 font-bold mt-4 mb-1 uppercase tracking-tight">$1</h4>')
                .replace(/## (.*?)(<br>|$)/g, '<h3 class="text-indigo-400 font-bold mt-6 mb-2 border-b border-slate-800 pb-1">$1</h3>');
        }

        function displaySession(session) {
            document.getElementById('welcomeScreen').classList.add('hidden');
            const container = document.getElementById('activeResponse');
            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="mb-12 p-6 glass rounded-2xl border-l-4 border-emerald-500 shadow-xl">
                    <div class="text-[10px] uppercase font-bold text-slate-500 mb-2 tracking-widest">Analysis Objective</div>
                    <div class="text-lg font-medium text-slate-100">${session.objective}</div>
                </div>
                <div class="prose prose-invert max-w-none text-slate-300 space-y-4">
                    ${formatDisplay(session.result)}
                </div>
            `;
            document.getElementById('outputArea').scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function callOllama(prompt, onChunk = null) {
            const url = document.getElementById('ollamaUrl').value.trim();
            const model = document.getElementById('modelSelect').value;
            const response = await fetch(`${url}/api/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model, messages: [{ role: "user", content: prompt }], stream: !!onChunk })
            });
            
            if (!response.ok) throw new Error("Ollama call failed.");

            if (!onChunk) {
                const data = await response.json();
                return data.message.content;
            } else {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunks = decoder.decode(value).split('\n');
                    for (const line of chunks) {
                        if (!line.trim()) continue;
                        try {
                            const json = JSON.parse(line);
                            if (json.message) {
                                fullText += json.message.content;
                                onChunk(json.message.content, fullText);
                            }
                        } catch(e) {}
                    }
                }
                return fullText;
            }
        }

        async function runProgrammaticRLM() {
            const source = currentExtractedText || document.getElementById('sourceInput').value.trim();
            const objective = document.getElementById('objectiveInput').value.trim();
            const chunkSize = parseInt(document.getElementById('chunkSize').value) || 6000;
            const btn = document.getElementById('runBtn');
            const prog = document.getElementById('programmaticProgress');
            const welcome = document.getElementById('welcomeScreen');
            const activeRes = document.getElementById('activeResponse');
            const outputArea = document.getElementById('outputArea');

            if (!source || !objective) return alert("Please provide source text and an objective.");

            btn.disabled = true;
            prog.classList.remove('hidden');
            welcome.classList.remove('hidden');
            activeRes.classList.add('hidden');

            const log = (step, progress) => {
                document.getElementById('stepLabel').innerText = step;
                document.getElementById('progressBar').style.width = `${progress}%`;
            };

            try {
                log("Decomposing Content...", 10);
                const chunks = [];
                for (let i = 0; i < source.length; i += chunkSize) {
                    chunks.push(source.substring(i, i + chunkSize));
                }

                log("Building Structure Map...", 25);
                // Map summaries for the architect
                const mapStr = chunks.map((c, idx) => `Chunk ${idx + 1}: ${c.substring(0, 350)}... [END]: ...${c.substring(c.length-150)}`).join('\n');
                
                const strategyResponse = await callOllama(STRATEGY_PROMPT.replace('{OBJECTIVE}', objective).replace('{MAP}', mapStr));
                
                let targetIDs = [];
                try {
                    const jsonMatch = strategyResponse.match(/\[[\s\d,]*\]/);
                    if(jsonMatch) targetIDs = JSON.parse(jsonMatch[0]);
                } catch (e) { console.error("Strategy Parse Error", e); }

                // Validation of targetIDs
                if (!targetIDs || targetIDs.length === 0) {
                    targetIDs = chunks.map((_, i) => i + 1);
                } else {
                    targetIDs = targetIDs.map(id => parseInt(id)).filter(id => id > 0 && id <= chunks.length);
                }

                welcome.classList.add('hidden');
                activeRes.classList.remove('hidden');
                activeRes.innerHTML = `
                    <div class="mb-12 p-6 glass rounded-2xl border-l-4 border-blue-500 shadow-xl">
                        <div class="text-[10px] uppercase font-bold text-slate-500 mb-2 tracking-widest">Architect Phase</div>
                        <div class="text-lg font-medium text-slate-100" id="currentActivity">Reviewing selected document chunks...</div>
                        <div id="skippedSummary" class="text-[10px] text-slate-500 mt-2 font-mono"></div>
                    </div>
                    <div id="logTrace" class="space-y-4 mb-8"></div>
                    <div id="finalReasoning" class="prose prose-invert max-w-none text-slate-300 pt-8 border-t border-slate-800 hidden"></div>
                `;

                const skipped = chunks.map((_, i) => i + 1).filter(id => !targetIDs.includes(id));
                if(skipped.length > 0) {
                    document.getElementById('skippedSummary').innerText = `Filtered out Chunks: ${skipped.join(', ')} (Low relevance)`;
                }

                log("Recursive Extraction...", 40);
                let allFacts = "";
                const trace = document.getElementById('logTrace');
                const activity = document.getElementById('currentActivity');

                for (let i = 0; i < targetIDs.length; i++) {
                    const id = targetIDs[i];
                    const idx = id - 1; 

                    const chunk = chunks[idx];
                    const percent = 40 + ((i / targetIDs.length) * 40);
                    log(`Extraction: Chunk ${id}/${chunks.length}...`, percent);
                    activity.innerText = `Extracting from Chunk ${id}...`;

                    const logBlock = document.createElement('div');
                    logBlock.className = 'p-4 glass rounded-xl border-l-2 border-slate-700 bg-slate-900/30';
                    logBlock.innerHTML = `<span class="phase-badge bg-blue-600/20 text-blue-400 border border-blue-500/30">CHUNK ${id}</span> <span class="typing ml-2 text-sm text-slate-400" id="chunk-txt-${id}">Reading...</span>`;
                    trace.appendChild(logBlock);
                    logBlock.scrollIntoView({ behavior: 'smooth' });

                    const fact = await callOllama(
                        EXTRACTION_PROMPT.replace('{OBJECTIVE}', objective).replace('{CHUNK}', chunk),
                        (chunkText, fullText) => {
                            document.getElementById(`chunk-txt-${id}`).innerHTML = formatDisplay(fullText);
                        }
                    );
                    document.getElementById(`chunk-txt-${id}`).classList.remove('typing');
                    if (!fact.toLowerCase().includes("no relevant content")) {
                        allFacts += `### SOURCE DATA: CHUNK ${id}\n${fact}\n\n`;
                    }
                }

                log("High Fidelity Synthesis...", 90);
                activity.innerText = "Generating Technical Summary...";
                const finalDiv = document.getElementById('finalReasoning');
                finalDiv.classList.remove('hidden');
                finalDiv.innerHTML = `<div class="flex items-center gap-4 mb-6"><span class="phase-badge bg-emerald-600 text-white">High Fidelity Technical Synthesis</span><div class="flex-1 border-t border-slate-800"></div></div><div id="finalTxt" class="typing"></div>`;
                
                const finalResponse = await callOllama(
                    SYNTHESIS_PROMPT.replace('{OBJECTIVE}', objective).replace('{FACTS}', allFacts || "No relevant data found in the selected chunks."),
                    (chunkText, fullText) => {
                        document.getElementById('finalTxt').innerHTML = formatDisplay(fullText);
                        outputArea.scrollTo({ top: outputArea.scrollHeight, behavior: 'instant' });
                    }
                );
                document.getElementById('finalTxt').classList.remove('typing');
                log("Analysis Complete", 100);
                activity.innerText = "Recursive Analysis Finished.";
                await saveSession(source, objective, finalResponse);

            } catch (err) {
                alert(err.message);
                welcome.classList.remove('hidden');
                welcome.innerHTML = `<div class="text-red-400 py-10">Error: ${err.message}</div>`;
            } finally {
                btn.disabled = false;
                setTimeout(() => prog.classList.add('hidden'), 3000);
            }
        }

        window.onload = () => { 
            fetchModels(); 
            // Default desktop view: Sidebar open, padding applied
            if(window.innerWidth >= 1024) {
                isSidebarOpen = true;
                document.getElementById('sidebar').classList.remove('-translate-x-full');
                document.getElementById('mainContent').classList.add('lg:pl-80');
            } else {
                isSidebarOpen = false;
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOpenBtn').classList.remove('hidden');
            }
        };

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes loading {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(300%); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
